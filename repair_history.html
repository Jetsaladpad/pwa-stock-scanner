<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="p-4">
    <a href="index.html" class="text-blue-600 hover:underline text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
  </div>

  <div class="max-w-7xl mx-auto p-6 bg-white rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-xl font-bold text-blue-600">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h1>
      <div class="text-right">
        <span id="totalSummary" class="font-semibold text-sm text-gray-700"></span>
      </div>
    </div>

    <div class="mb-4 flex gap-4 flex-wrap">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:
        <input type="month" id="monthFilter" class="border px-2 py-1 rounded">
      </label>
      <button onclick="filterHistory()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead class="bg-gray-200">
          <tr class="text-left">
            <th class="p-2 border">#</th>
            <th class="p-2 border">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th class="p-2 border">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th class="p-2 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="p-2 border">‡∏ä‡∏ô‡∏¥‡∏î‡∏£‡∏ñ</th>
            <th class="p-2 border">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th>
            <th class="p-2 border">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
            <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="p-2 border text-right">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)</th>
            <th class="p-2 border text-center">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    let allHistory = JSON.parse(localStorage.getItem("repairHistory") || "[]");

    function filterHistory() {
      const table = document.getElementById("historyTable");
      table.innerHTML = "";

      const selectedMonth = document.getElementById("monthFilter").value;
      let filtered = allHistory;

      if (selectedMonth) {
        filtered = allHistory.filter(item => item.date.startsWith(selectedMonth));
      }

      if (filtered.length === 0) {
        table.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        document.getElementById("totalSummary").textContent = "";
        return;
      }

      let total = 0;
      filtered.forEach((item, index) => {
        let sum = 0;
        if (item.usedParts && Array.isArray(item.usedParts)) {
          sum = item.usedParts.reduce((acc, part) => acc + (part.price * (part.qty || 1)), 0);
        }
        total += sum;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="border p-2">${index + 1}</td>
          <td class="border p-2">${item.name}</td>
          <td class="border p-2">${item.license}</td>
          <td class="border p-2">${item.date}</td>
          <td class="border p-2">${item.type}</td>
          <td class="border p-2">${item.brand}</td>
          <td class="border p-2">${item.problem || "-"}</td>
          <td class="border p-2 text-green-600">${item.status}</td>
          <td class="border p-2 text-right">${sum.toFixed(2)}</td>
          <td class="border p-2 text-center space-x-2">
            <button onclick="reprint(${index})" class="text-blue-600 hover:underline text-sm">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            <button onclick="deleteHistory(${index})" class="text-red-600 hover:underline text-sm">‡∏•‡∏ö</button>
          </td>
        `;
        table.appendChild(row);
      });

      document.getElementById("totalSummary").textContent = `üî• ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
    }

    function deleteHistory(index) {
      if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        allHistory.splice(index, 1);
        localStorage.setItem("repairHistory", JSON.stringify(allHistory));
        filterHistory();
      }
    }

    function reprint(index) {
      const repair = allHistory[index];
      localStorage.setItem("selectedRepair", JSON.stringify(repair));
      window.location.href = "cash_bill.html";
    }

    filterHistory();
  </script>
</body>
</html>
